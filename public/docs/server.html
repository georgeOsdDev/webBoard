<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Author: Takeharu.Oshida<br>
repository: https://github.com/georgeOsdDev/webBoard<br>
Licence: MIT<br></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>module dependencies</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">express  = </span><span class="nx">require</span> <span class="s">&#39;express&#39;</span>
<span class="nv">routes   = </span><span class="nx">require</span> <span class="s">&#39;./routes&#39;</span>
<span class="nv">http     = </span><span class="nx">require</span> <span class="s">&#39;http&#39;</span>
<span class="nv">path     = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">socketIO = </span><span class="nx">require</span> <span class="s">&#39;socket.io&#39;</span>
<span class="nv">stylus   = </span><span class="nx">require</span> <span class="s">&#39;stylus&#39;</span>
<span class="nv">nib      = </span><span class="nx">require</span> <span class="s">&#39;nib&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>compile function of stylus using <code>nib</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compile = </span><span class="nf">(str, path) -&gt;</span>
  <span class="nx">stylus</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;compress&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">use</span><span class="p">(</span><span class="nx">nib</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>create express instance
and set config</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">app = </span><span class="nx">express</span><span class="p">()</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span> <span class="o">-&gt;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;title&#39;</span><span class="p">,</span><span class="s">&#39;WhiteBoard&#39;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;port&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;views&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/views&quot;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;view engine&#39;</span><span class="p">,</span> <span class="s">&#39;ejs&#39;</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">favicon</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">stylus</span><span class="p">.</span><span class="nx">middleware</span><span class="p">({</span> <span class="nv">src: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/public&quot;</span><span class="p">,</span><span class="nv">compile: </span><span class="nx">compile</span> <span class="p">})</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;public&#39;</span><span class="p">))</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">app</span><span class="p">.</span><span class="nx">router</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Routing<br>
<a href="/">/</a> is entry point of this site <br>
<a href="/docs">/docs</a> routes documentation files generated by <a href="http://jashkenas.github.com/docco/">docco</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">index</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/index&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">index</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/index.html&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">index</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/docs&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">docs</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/docs.html&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">docs</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create server and listen it with socket.IO</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">io = </span><span class="nx">socketIO</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;port&#39;</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Express server listening on port </span><span class="si">#{</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;port&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Go http://</span><span class="si">#{</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_HOST</span> <span class="o">||</span> <span class="s">&#39;localhost&#39;</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;port&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">/&quot;</span> </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>set log level rower</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">io</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;log level&#39;</span><span class="p">,</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Namespace of application</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">webBoard =</span>
  <span class="nx">activeUser</span><span class="o">:</span><span class="mi">0</span>
  <span class="nx">objectList</span><span class="o">:</span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Socket.io event handler</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;connection&#39;</span><span class="p">,</span>  <span class="nf">(socket) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;new user connected&quot;</span>
  <span class="nx">webBoard</span><span class="p">.</span><span class="nx">activeUser</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Initialize client</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sendData =</span>
    <span class="nv">action : </span><span class="s">&#39;initialize&#39;</span>
    <span class="nv">actionData : </span><span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="nx">sendData</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Handle message
client emit message to server and then, server broadcast to other clients.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
    <span class="nv">action = </span><span class="nx">data</span><span class="p">.</span><span class="nx">action</span>
    <span class="nv">actionData = </span><span class="nx">data</span><span class="p">.</span><span class="nx">actionData</span>
    <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s">&#39;createObj&#39;</span>
      <span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span><span class="p">[</span><span class="nx">actionData</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">actionData</span><span class="p">.</span><span class="nx">object</span>
    <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s">&#39;moveObj&#39;</span>
      <span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span><span class="p">[</span><span class="nx">actionData</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nv">top = </span><span class="nx">actionData</span><span class="p">.</span><span class="nx">top</span>
      <span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span><span class="p">[</span><span class="nx">actionData</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nv">left = </span><span class="nx">actionData</span><span class="p">.</span><span class="nx">left</span>
    <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s">&#39;removeObj&#39;</span>
      <span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span><span class="p">[</span><span class="nx">actionData</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s">&#39;editObj&#39;</span>
      <span class="nx">webBoard</span><span class="p">.</span><span class="nx">objectList</span><span class="p">[</span><span class="nx">actionData</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nv">body = </span><span class="nx">actionData</span><span class="p">.</span><span class="nx">body</span>
    <span class="k">if</span> <span class="nx">action</span> <span class="o">is</span> <span class="s">&#39;clearAll&#39;</span>
      <span class="nv">webBoard.objectList = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>BroadCast message to clients</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Heartbeat</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;heartbeat&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>console.log " #{socket.id} is alive"</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Disconnect</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">webBoard</span><span class="p">.</span><span class="nx">activeUser</span><span class="o">--</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;one user disconnected </span><span class="si">#{</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Error</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(event)-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Error occured&quot;</span><span class="p">,</span> <span class="nx">event</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 